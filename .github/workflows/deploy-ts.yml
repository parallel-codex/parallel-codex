name: Deploy TypeScript (npm)
on:
  push:
    tags: ["ts-v*"]
  workflow_dispatch: {}
permissions:
  contents: read
jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Build (TypeScript package)
        run: npm run build --workspace @parallel-codex/typescript-package
      - name: Run tests (TypeScript package)
        run: npm run test --workspace @parallel-codex/typescript-package
      - name: Determine version and publish tag
        id: meta
        run: |
          VER=$(node -p "require('./packages/typescript-package/package.json').version")
          echo "version=$VER" >> $GITHUB_OUTPUT
          # Choose npm dist-tag based on pre-release
          if [[ "$VER" == *"-beta."* ]]; then
            TAG="beta"
          elif [[ "$VER" == *"-rc."* ]]; then
            TAG="next"
          elif [[ "$VER" == *"-"* ]]; then
            TAG="next"
          else
            TAG="latest"
          fi
          echo "publish_tag=$TAG" >> $GITHUB_OUTPUT
      - name: Skip if version already published
        id: already
        run: |
          PKG='@parallel-codex/typescript-package'
          VER='${{ steps.meta.outputs.version }}'
          # Check if the version already exists on npm
          if npm view "$PKG" versions --json >/tmp/versions.json 2>/dev/null; then
            if node -e "const fs=require('fs');const v=process.argv[1];const raw=fs.readFileSync('/tmp/versions.json','utf8');let arr=[];try{arr=JSON.parse(raw);}catch{};if(!Array.isArray(arr))arr=[arr];if(arr.includes(v))process.exit(0);process.exit(1);" "$VER"; then
              echo "Version $VER already on npm. Skipping publish."
              echo "skip=true" >> $GITHUB_OUTPUT
            else
              echo "skip=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      - name: Publish to npm
        if: steps.already.outputs.skip != 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}
        run: |
          npm publish --workspace @parallel-codex/typescript-package --access public --provenance --tag '${{ steps.meta.outputs.publish_tag }}'

name: Deploy TypeScript Package

on:
  push:
    branches:
      - dev
      - main
    paths:
      - 'packages/typescript-package/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name == 'main' && 'production' || 'development' }}
    permissions:
      contents: read
      id-token: write  # Required for npm OIDC authentication
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}
      NPM_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org/'
          always-auth: true
          scope: '@parallel-codex'

      - name: Verify npm publish token
        run: |
          echo "NODE_AUTH_TOKEN length: ${#NODE_AUTH_TOKEN}"
          if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
            echo "Missing NODE_AUTH_TOKEN. Please configure the NPM_PUBLISH_TOKEN secret."
            exit 1
          fi

      - name: Inspect npm configuration
        run: |
          echo "repo .npmrc:"
          if [ -f .npmrc ]; then
            sed -E 's/(authToken=).*/\1[masked]/' .npmrc
          else
            echo "  [none]"
          fi
          echo "user npmrc (${NPM_CONFIG_USERCONFIG:-unset}):"
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ] && [ -f "${NPM_CONFIG_USERCONFIG}" ]; then
            sed -E 's/(authToken=).*/\1[masked]/' "${NPM_CONFIG_USERCONFIG}"
          else
            echo "  [none]"
          fi

      - name: Confirm npm authentication
        run: |
          set +e
          npm whoami --registry=https://registry.npmjs.org --scope=@parallel-codex
          status=$?
          set -e
          if [ $status -ne 0 ]; then
            echo "npm whoami failed with exit code $status"
            mkdir -p "$RUNNER_TEMP/npm-logs"
            find /home/runner/.npm/_logs -maxdepth 1 -type f -name '*-debug-*.log' -exec cp {} "$RUNNER_TEMP/npm-logs/" \; -print
            exit $status
          fi

      - name: Upload npm logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: npm-logs
          path: ${{ runner.temp }}/npm-logs
          if-no-files-found: ignore

      - run: npm ci

      - name: Build package
        working-directory: packages/typescript-package
        run: npm run build

      - name: Test package
        working-directory: packages/typescript-package
        run: npm test

      - name: Publish beta version
        if: github.ref_name == 'dev'
        working-directory: packages/typescript-package
        run: |
          npm version prerelease --preid=beta --no-git-tag-version
          npm publish --tag beta

      - name: Publish stable version
        if: github.ref_name == 'main'
        working-directory: packages/typescript-package
        run: npm publish --tag latest
